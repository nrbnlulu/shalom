name: CI/CD Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build-and-test:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@v1
              with:
                  toolchain: 1.89.0
                  override: true
                  components: rustfmt, clippy

            - name: Setup Flutter SDK
              uses: flutter-actions/setup-flutter@v4
              with:
                  channel: stable
                  version: 3.38.1

            - name: Install Task
              uses: arduino/setup-task@v2
              with:
                  version: 3.x
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install flutter packages
              run: |
                  cd rust/shalom_dart_codegen/dart_tests/
                  flutter packages get

            - name: Test
              run: |
                  task test

            - name: Install typos
              run: |
                  cargo install typos-cli

            - name: Lint
              if: runner.os == 'Linux'
              run: task lint

    anilist-example:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@v1
              with:
                  toolchain: 1.89.0
                  override: true

            - name: Setup Flutter SDK
              uses: flutter-actions/setup-flutter@v4
              with:
                  channel: stable
                  version: 3.38.1

            - name: Build shalom CLI
              run: |
                  cd rust
                  cargo build -p shalom_dart_codegen

            - name: Run codegen for AniList example
              run: |
                  ./rust/target/debug/shalom generate --path examples/anilist

            - name: Install AniList dependencies
              run: |
                  cd examples/anilist
                  flutter pub get

            - name: Build AniList example
              run: |
                  cd examples/anilist
                  flutter build web
